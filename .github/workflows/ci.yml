name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

      - name: Format check with black
        run: |
          black --check --diff .

      - name: Test imports and basic functionality
        run: |
          python -c "import src.ingest; print('Ingest module imported successfully')"
          python -c "import src.rag; print('RAG module imported successfully')"
          python -c "import app; print('Flask app imported successfully')"

      - name: Create sample documents for testing
        run: |
          mkdir -p test_policies
          echo "# Test Policy\nThis is a test policy document." > test_policies/test.md

      - name: Test document ingestion (without embeddings)
        run: |
          python -c "
          from src.ingest import DocumentProcessor, TextChunker
          from pathlib import Path

          processor = DocumentProcessor()
          chunker = TextChunker()

          # Test document processing
          doc = processor.process_file(Path('test_policies/test.md'))
          print(f'Processed document: {doc[\"title\"]}')

          # Test chunking
          chunks = chunker.chunk_document(doc)
          print(f'Created {len(chunks)} chunks')

          print('Document processing test passed!')
          "

      - name: Test Flask app startup
        run: |
          timeout 10s python -c "
          import app
          print('Flask app can be imported and initialized')
          " || echo "App startup test completed (expected timeout)"

  security-scan:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Run security scan with bandit
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . || true

  deploy:
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to staging
        run: |
          echo "Deployment step would go here"
          echo "Could deploy to Render, Railway, or other platforms"
          echo "Environment: staging"
          echo "Branch: ${{ github.ref }}"

      - name: Health check after deployment
        run: |
          echo "Health check would verify deployment"
          echo "Could test /health endpoint"
